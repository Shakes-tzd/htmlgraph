<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="htmlgraph-version" content="1.0">
    <title>Plugin Hook Cache Failure Root Cause Analysis</title>
    <link rel="stylesheet" href="../styles.css">
</head>
<body>
    <article id="spk-add6e176"
             data-type="spike"
             data-status="todo"
             data-priority="medium"
             data-created="2026-01-04T17:41:52.874798"
             data-updated="2026-01-04T17:41:52.874803" data-spike-type="general">

        <header>
            <h1>Plugin Hook Cache Failure Root Cause Analysis</h1>
            <div class="metadata">
                <span class="badge status-todo">Todo</span>
                <span class="badge priority-medium">Medium Priority</span>
            </div>
        </header>

    
        <section data-spike-metadata>
            <h3>Spike Metadata</h3>
            <dl>
                <dt>Type</dt>
                <dd>General</dd>
            </dl>
        </section>
        <section data-findings>
            <h3>Findings</h3>
            <div class="findings-content">
                # Root Cause Analysis: Claude Code Plugin Hook Path Stale Cache Issue

## Executive Summary

**Issue**: After upgrading HtmlGraph plugin from 0.23.5 to 0.24.0, hooks continued pointing to non-existent 0.23.5 cache directory, causing cascading failure that blocked ALL operations.

**Root Cause**: Known Claude Code framework bug - `CLAUDE_PLUGIN_ROOT` environment variable resolves to stale cache paths after plugin updates due to:
1. Cached/inherited environment variables across sessions
2. Stale `gitCommitSha` in plugin metadata causing incorrect cache lookup
3. No cache invalidation during plugin upgrade process

**Status**: Framework bug confirmed via GitHub issues #15642, #13612, #15621, #14061, #15369

---

## Investigation Findings

### 1. Hook Registration Mechanism

**How HtmlGraph Registers Hooks:**

File: `packages/claude-plugin/hooks/hooks.json`

```json
{
  "hooks": {
    "PreToolUse": [{
      "matcher": "",
      "hooks": [{
        "type": "command",
        "command": "uv run "${CLAUDE_PLUGIN_ROOT}/hooks/scripts/pretooluse-integrator.py""
      }]
    }],
    "PostToolUse": [{
      "matcher": "",
      "hooks": [{
        "type": "command",
        "command": "uv run "${CLAUDE_PLUGIN_ROOT}/hooks/scripts/posttooluse-integrator.py""
      }]
    }]
    // ... more hooks
  }
}
```

**Key Observation:**
- HtmlGraph correctly uses `${CLAUDE_PLUGIN_ROOT}` variable (NOT hardcoded paths)
- Hook scripts are thin wrappers that delegate to `htmlgraph` package
- Scripts use inline PEP 723 dependencies: `# dependencies = ["htmlgraph"]`

**Example Hook Script (pretooluse-integrator.py):**
```python
#!/usr/bin/env -S uv run
# /// script
# requires-python = ">=3.10"
# dependencies = ["htmlgraph"]
# ///
from htmlgraph.hooks.pretooluse import main

if __name__ == "__main__":
    main()
```

**Architecture**: All hook logic lives in the `htmlgraph` Python package, NOT in plugin scripts. This means hook behavior updates with package upgrades, NOT plugin upgrades.

---

### 2. Claude Code Plugin Cache Structure

**Cache Locations Found:**

```
~/.claude/plugins/cache/
‚îú‚îÄ‚îÄ htmlgraph/htmlgraph/0.24.0/          ‚Üê Current version (works)
‚îî‚îÄ‚îÄ local-marketplace/htmlgraph/
    ‚îú‚îÄ‚îÄ 0.20.9/
    ‚îú‚îÄ‚îÄ 0.21.0/
    ‚îú‚îÄ‚îÄ 0.22.0/
    ‚îú‚îÄ‚îÄ 0.23.0/
    ‚îú‚îÄ‚îÄ 0.23.1/
    ‚îî‚îÄ‚îÄ 0.23.2/                          ‚Üê Latest local-marketplace version
```

**Missing**: Version 0.23.5 directory does NOT exist in either location.

**Key Insight**: The error referenced `~/.claude/plugins/cache/htmlgraph/htmlgraph/0.23.5/hooks/scripts/pretooluse-integrator.py` which never existed. This means `CLAUDE_PLUGIN_ROOT` was resolving to a phantom path.

---

### 3. Framework Bug: Stale CLAUDE_PLUGIN_ROOT Resolution

**Confirmed via GitHub Issues:**

**Issue #15642: "Plugin cache: CLAUDE_PLUGIN_ROOT points to stale version after plugin update"**
- Status: OPEN (reported within last 4 weeks as of Jan 2026)
- Platform: Affects all platforms (Linux/WSL2 confirmed, likely macOS too)
- Claude Code Version: 2.0.76+ affected

**Root Cause Mechanism:**
1. Plugin upgrade runs (`claude plugin install htmlgraph@0.24.0`)
2. Claude Code updates `installed_plugins.json` with new version metadata
3. NEW sessions start and load plugin hooks
4. `CLAUDE_PLUGIN_ROOT` environment variable resolves using:
   - **BUG**: Cached/inherited env vars from previous session, OR
   - **BUG**: Stale `gitCommitSha` field used for cache lookup instead of `version` field
5. Hook commands execute with wrong path (e.g., `.../0.23.5/...` instead of `.../0.24.0/...`)
6. Scripts fail with "No such file or directory"

**Evidence from Issue #15642:**
```json
// installed_plugins.json shows correct version
{
  "devloop@cc-plugins": [{
    "version": "2.4.7",              // ‚úÖ Correct
    "installPath": ".../2.4.7",      // ‚úÖ Correct
    "gitCommitSha": "f42d089..."     // ‚ùå STALE (211 commits behind)
  }]
}
```

Session logs showed:
- 1√ó reference to `devloop/2.4.4` (stale)
- 6√ó references to `devloop/2.4.7` (correct)

**Related Issue #13612: "Import error due to versioned cache path"**
- Different symptom (Python import failures), same root cause
- Versioned cache paths don't align with module resolution

---

### 4. Why Version 0.23.5 Specifically?

**Theory:** Version 0.23.5 was likely:
1. A version number that was planned/committed in git but never actually deployed to the marketplace
2. Or: `gitCommitSha` from 0.23.5 git commit used for cache lookup, but cache directory was never created
3. Or: Race condition during upgrade where metadata updated but cache directory wasn't copied yet

**Evidence:**
- Marketplace file at `~/.claude/plugins/marketplaces/htmlgraph/.claude-plugin/marketplace.json` shows `"version": "0.23.5"`
- But no 0.23.5 cache directory exists in `~/.claude/plugins/cache/local-marketplace/htmlgraph/`
- Current working version is 0.24.0 in different cache location (`htmlgraph/htmlgraph/0.24.0`)

**Implication**: Dual marketplace registration (local-marketplace vs htmlgraph namespace) may have caused version mismatch.

---

## Root Cause Summary

**PRIMARY CAUSE: Claude Code Framework Bug**

The failure is NOT caused by HtmlGraph plugin implementation. HtmlGraph correctly:
- ‚úÖ Uses `${CLAUDE_PLUGIN_ROOT}` (not hardcoded paths)
- ‚úÖ Follows plugin structure conventions
- ‚úÖ Delegates logic to package (version-independent)

The failure IS caused by Claude Code framework:
- ‚ùå `CLAUDE_PLUGIN_ROOT` resolves to stale/non-existent cache paths after upgrades
- ‚ùå No cache invalidation during plugin update process
- ‚ùå `gitCommitSha` metadata becomes stale and causes incorrect lookups
- ‚ùå No fallback mechanism when hook scripts don't exist

**SECONDARY CAUSE: Cascading Failure Design**

When hook scripts fail, Claude Code blocks ALL operations including:
- Plugin uninstall/reinstall commands (chicken-and-egg problem)
- Any tool use (PreToolUse hook fails first)
- Session management (hooks run on every operation)

**Manual intervention required**: Edit `~/.claude/settings.json` to disable plugin.

---

## Prevention Strategy

### For HtmlGraph Plugin (Defensive Coding)

**Option 1: Add Existence Check to Hook Scripts**
```python
#!/usr/bin/env -S uv run
import sys
from pathlib import Path

# Defensive: Check if we're running from expected location
plugin_root = Path(__file__).parent.parent.parent
if not plugin_root.exists():
    print(f"WARNING: Plugin root does not exist: {plugin_root}", file=sys.stderr)
    sys.exit(0)  # Graceful exit instead of hard failure

from htmlgraph.hooks.pretooluse import main
if __name__ == "__main__":
    main()
```

**PRO**: Prevents cascading failures
**CON**: Silently hides framework bugs, may mask real issues

**Option 2: Add Version Mismatch Detection**
```python
#!/usr/bin/env -S uv run
import os
import sys

# Check if CLAUDE_PLUGIN_ROOT points to outdated version
plugin_root = os.environ.get("CLAUDE_PLUGIN_ROOT", "")
expected_version = "0.24.0"  # Read from plugin.json dynamically

if expected_version not in plugin_root:
    print(f"ERROR: Plugin cache version mismatch!", file=sys.stderr)
    print(f"  Expected version: {expected_version}", file=sys.stderr)
    print(f"  Current path: {plugin_root}", file=sys.stderr)
    print(f"  Fix: Run 'claude plugin update htmlgraph'", file=sys.stderr)
    sys.exit(1)
```

**PRO**: Surfaces the issue with actionable error message
**CON**: Still blocks operations, but at least user knows why

**RECOMMENDATION**: **DO NOT implement defensive coding**
- This is a framework bug that affects ALL plugins
- Defensive coding masks the symptom, doesn't fix the cause
- Better to surface the issue loudly so framework team fixes it
- HtmlGraph is correctly implemented per Claude Code plugin spec

### For Users (Upgrade Workflow)

**Current (Broken) Workflow:**
```bash
claude plugin install htmlgraph@0.24.0  # ‚ùå May use stale cache
```

**Recommended Workflow:**
```bash
# 1. Uninstall old version first
claude plugin uninstall htmlgraph

# 2. Clear cache manually (workaround)
rm -rf ~/.claude/plugins/cache/htmlgraph
rm -rf ~/.claude/plugins/cache/local-marketplace/htmlgraph

# 3. Install new version
claude plugin install htmlgraph@0.24.0

# 4. Verify installation
claude plugin list | grep htmlgraph
```

**LIMITATION**: This won't work if hooks are already broken (can't uninstall).

**Nuclear Option (Hooks Already Broken):**
```bash
# 1. Disable plugin in settings.json
# Edit ~/.claude/settings.json:
# "htmlgraph@htmlgraph": false

# 2. Start new session
# 3. Follow recommended workflow above
# 4. Re-enable plugin in settings.json
```

### For Framework (Claude Code Team)

**Short-term Fixes:**
1. **Graceful degradation**: If hook script doesn't exist, log warning and continue
2. **Cache invalidation**: Clear old version caches during plugin upgrade
3. **Fallback logic**: Use `version` field if `gitCommitSha` lookup fails

**Long-term Fixes:**
1. **Atomic upgrades**: Ensure cache directory exists before updating metadata
2. **Version locking**: Pin `CLAUDE_PLUGIN_ROOT` to `version` field, not `gitCommitSha`
3. **Health checks**: Validate hook paths before executing
4. **Recovery mode**: Allow plugin uninstall/reinstall even when hooks fail

---

## Fix Recommendation

**For HtmlGraph Plugin: NO CODE CHANGES NEEDED**

The plugin is correctly implemented. Any defensive coding would:
- Mask a critical framework bug
- Set bad precedent for other plugin developers
- Add maintenance burden for working around framework issues

**For Users: Document Workaround**

Add to HtmlGraph documentation:
```markdown
## Troubleshooting: Plugin Upgrade Failures

If you encounter "No such file or directory" errors after upgrading:

**Symptom**: Hooks fail with paths like `.../0.23.5/hooks/scripts/...`

**Cause**: Known Claude Code bug (#15642) - stale cache paths after upgrades

**Fix**:
1. Edit `~/.claude/settings.json`
2. Set `"htmlgraph@htmlgraph": false`
3. Start new Claude session
4. Run: `claude plugin uninstall htmlgraph`
5. Run: `rm -rf ~/.claude/plugins/cache/htmlgraph`
6. Run: `claude plugin install htmlgraph@latest`
7. Edit `~/.claude/settings.json` back to `"htmlgraph@htmlgraph": true`
8. Start new Claude session
```

**For Claude Code Team: Report Findings**

Link to GitHub issues:
- #15642 (CLAUDE_PLUGIN_ROOT stale cache)
- #13612 (Import errors from versioned cache)
- #15621, #14061, #15369 (Related cache invalidation issues)

Request prioritization of cache invalidation fixes.

---

## Related Issues & Evidence

### GitHub Issues (Claude Code Repository)

1. **[Issue #15642](https://github.com/anthropics/claude-code/issues/15642)**: Plugin cache: CLAUDE_PLUGIN_ROOT points to stale version after plugin update
   - Status: OPEN
   - Labels: bug, area:core, has repro, platform:linux
   - Impact: Session uses outdated plugin scripts despite correct metadata

2. **[Issue #13612](https://github.com/anthropics/claude-code/issues/13612)**: [hookify plugin] Import error: No module named 'hookify' due to versioned cache path
   - Status: CLOSED (duplicate of #13568)
   - Impact: Python imports fail due to cache path structure

3. **Related Issues**: #15621, #14061, #15369
   - All related to plugin cache invalidation problems
   - Indicates systemic issue with plugin upgrade workflow

### Cache State Evidence

**Current System State:**
- `~/.claude/installed_plugins.json`: DOES NOT EXIST
- Cache has 0.24.0 in `htmlgraph/htmlgraph/` namespace (working)
- Cache has up to 0.23.2 in `local-marketplace/htmlgraph/` namespace
- Missing 0.23.5 cache directory (phantom version)

**Marketplace Metadata:**
- `~/.claude/plugins/marketplaces/htmlgraph/.claude-plugin/marketplace.json` shows version "0.23.5"
- Mismatch between marketplace version and installed version

---

## Conclusion

This is a **confirmed Claude Code framework bug**, not a HtmlGraph plugin implementation issue.

**Key Takeaways:**
1. ‚úÖ HtmlGraph plugin is correctly implemented per specification
2. ‚ùå Claude Code plugin upgrade process has critical cache invalidation bug
3. ‚ö†Ô∏è Affects ALL plugins using hooks with `${CLAUDE_PLUGIN_ROOT}`
4. üîß Workaround exists (manual cache clearing) but requires user intervention
5. üìã Framework team aware (multiple open issues) but not yet fixed

**Recommendation**: Document workaround for users, escalate to Claude Code team for framework fix, DO NOT add defensive coding to plugin.

## Additional Finding: Orchestrator Prompt Delegation Confusion

**Bug Created:** bug-214adb07

**Issue:**
The orchestrator system prompt shows HeadlessSpawner Python code examples that Claude Code agents cannot execute directly.

**What went wrong in this session:**
1. I read orchestrator prompt showing: `spawner = HeadlessSpawner(); result = spawner.spawn_gemini(...)`
2. I tried to execute via: `Bash(uv run python -c "from htmlgraph.orchestration...")`
3. This failed because agents don't have a Python REPL environment
4. Correct approach: `Task(subagent_type="htmlgraph:gemini-spawner", prompt="...")`

**Root Cause:**
Orchestrator prompt mixes two audiences:
- Implementation examples (for developers using HeadlessSpawner in code)
- Agent instructions (should use Task tool with subagent types)

**Fix Required:**
Update orchestrator system prompt to show Task() tool examples instead of raw Python HeadlessSpawner code.

**Correct pattern:**
```
# ‚úÖ Use Task with spawner subagent types
Task(subagent_type="htmlgraph:gemini-spawner", prompt="...")
Task(subagent_type="htmlgraph:codex-spawner", prompt="...")
Task(subagent_type="htmlgraph:copilot-spawner", prompt="...")

# ‚ùå Don't try to run HeadlessSpawner via Bash
Bash("uv run python -c 'from htmlgraph.orchestration...'")
```

            </div>
        </section>
    </article>
</body>
</html>
