<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="htmlgraph-version" content="1.0">
    <title>HtmlGraph Delegation Recording & Tracking System</title>
    <link rel="stylesheet" href="../styles.css">
</head>
<body>
    <article id="spk-2caa7e83"
             data-type="spike"
             data-status="todo"
             data-priority="medium"
             data-created="2026-01-07T16:05:05.950709"
             data-updated="2026-01-07T16:05:05.950713" data-spike-type="general" data-timebox-hours="4" data-agent-assigned="delegation-researcher">

        <header>
            <h1>HtmlGraph Delegation Recording & Tracking System</h1>
            <div class="metadata">
                <span class="badge status-todo">Todo</span>
                <span class="badge priority-medium">Medium Priority</span>
            </div>
        </header>

    
        <section data-spike-metadata>
            <h3>Spike Metadata</h3>
            <dl>
                <dt>Type</dt>
                <dd>General</dd>
                <dt>Timebox</dt>
                <dd>4 hours</dd>
            </dl>
        </section>
        <section data-findings>
            <h3>Findings</h3>
            <div class="findings-content">
                ## Delegation Recording System - Complete Analysis

### Summary
HtmlGraph implements a comprehensive delegation tracking system with:
- **Automatic recording** of Task() calls and spawner executions
- **Multi-layer storage** (JSONL event logs + SQLite database + HTML sessions)
- **Parent-child session relationships** for subagent tracking
- **Rich metadata capture** for cost accounting and analytics

---

## Are Delegations Recorded?

**YES - Automatically and Comprehensively**

Every delegation is recorded across multiple systems:

### 1. **EventRecord (JSONL - Source of Truth)**
Location: `.htmlgraph/events/{session_id}.jsonl`

Fields tracked:
- `delegated_to_ai` - Which AI system (gemini, codex, copilot, claude)
- `task_id` - Unique task identifier
- `task_status` - pending, running, completed, failed, timeout
- `model_selected` - Specific model (e.g., gemini-2.0-flash)
- `complexity_level` - low, medium, high, very-high
- `budget_mode` - free, balanced, performance
- `execution_duration_seconds` - How long delegation took
- `tokens_estimated` - Estimated token usage
- `tokens_actual` - Actual token usage from response
- `cost_usd` - Calculated cost
- `task_findings` - Results from delegated task
- `parent_session_id` - Link to parent session (orchestrator → subagent)

**File**: `src/python/htmlgraph/event_log.py` lines 24-89

### 2. **SQLite Database (Query-friendly)**
Location: `.htmlgraph/index.sqlite` (optional, auto-created)

Tables:
- **agent_events** - Individual tool calls and delegations
  - Columns: event_id, agent_id, event_type, timestamp, tool_name, parent_agent_id, parent_event_id
- **agent_collaboration** - Agent handoffs and delegations
  - Columns: handoff_id, from_agent, to_agent, timestamp, handoff_type (delegation/parallel/sequential), status, context
- **sessions** - Session tracking with parent-child relationships
  - Columns: session_id, parent_session_id, parent_event_id, is_subagent, transcript_id

**File**: `src/python/htmlgraph/db/schema.py`

Key methods:
- `record_delegation_event()` - Records Task() delegations
- `insert_collaboration()` - Records agent handoffs
- `get_delegations()` - Query delegations with filters

### 3. **HTML Sessions (Human-readable)**
Location: `.htmlgraph/sessions/{session_id}.html`

Each session includes:
- Activity log with all tool calls
- Features worked on (links to delegated work items)
- Session lifecycle (started_at, ended_at)
- Parent-child relationships

---

## Recording Mechanism

### Hook System (Automatic Capture)

**PostToolUse Hook** (`src/python/htmlgraph/hooks/posttooluse.py`):
- Runs in parallel after every tool execution
- Calls `track_event()` to log to session + database
- Tracks delegation metadata automatically

**Event Tracker** (`src/python/htmlgraph/hooks/event_tracker.py`):
- Main entry point for all activity tracking
- Reads parent session from `HTMLGRAPH_PARENT_SESSION` env var
- Creates EventRecord with delegation fields
- Appends to JSONL event log
- Updates SQLite index if it exists

**Session Start Hook** (`.claude/hooks/scripts/session-start.py`):
- Creates new session with parent_session_id if spawned as subagent
- Sets `HTMLGRAPH_PARENT_SESSION` env var for child processes
- Links parent → child sessions

---

## What Gets Recorded About Each Delegation

### EventRecord Fields (Complete List)

```python
EventRecord(
    event_id: str,              # Unique hash-based ID
    timestamp: datetime,        # When delegation occurred
    session_id: str,           # Current session
    agent: str,                # Which agent is running
    tool: str,                 # Tool name (Task, Skill, etc.)
    summary: str,              # Human-readable summary
    success: bool,             # Did it succeed?
    feature_id: str | None,    # Attributed feature
    drift_score: float | None, # How far from feature?
    
    # === Delegation-specific fields ===
    parent_session_id: str | None,  # Parent session (for subagents)
    delegated_to_ai: str | None,    # "gemini", "codex", "copilot", "claude"
    task_id: str | None,            # Unique task ID
    task_status: str | None,        # pending, running, completed, failed
    model_selected: str | None,     # e.g., "gemini-2.0-flash"
    complexity_level: str | None,   # low, medium, high, very-high
    budget_mode: str | None,        # free, balanced, performance
    execution_duration_seconds: float | None,
    tokens_estimated: int | None,
    tokens_actual: int | None,
    cost_usd: float | None,
    task_findings: str | None,      # Result summary
)
```

### AgentCollaboration Fields (Database)

```python
agent_collaboration(
    handoff_id: str,        # Unique handoff ID
    from_agent: str,        # Delegating agent
    to_agent: str,          # Receiving agent
    timestamp: datetime,
    feature_id: str | None, # Linked work item
    session_id: str,
    handoff_type: str,      # delegation, parallel, sequential, fallback
    status: str,            # pending, accepted, rejected, completed, failed
    reason: str,            # Why delegation happened
    context: JSON,          # Additional metadata
)
```

---

## Where Data Is Stored

### Three-Layer Storage Architecture

**Layer 1: JSONL Event Logs (Source of Truth)**
```
.htmlgraph/events/
├── sess-abc123.jsonl    # Session 1 events
├── sess-def456.jsonl    # Session 2 events
└── ...
```
- Append-only for Git-friendliness
- One file per session
- Queryable with `JsonlEventLog.query_events()`

**Layer 2: SQLite Database (Queryable)**
```
.htmlgraph/index.sqlite  # Optional (auto-created, persistent)
├── agent_events         # Tool calls and delegations
├── agent_collaboration  # Handoffs and delegations
├── sessions             # Session tracking
└── features             # Work items
```
- Indexes on frequently queried fields
- Foreign key constraints
- Fast queries via SQL

**Layer 3: HTML Sessions (Human-readable)**
```
.htmlgraph/sessions/
├── sess-abc123.html     # Session view with activity log
├── sess-def456.html
└── ...
```
- Converted from JSON
- Includes bidirectional links
- Can be opened in browser

---

## Parent-Child Session Relationships

### How Subagent Sessions Are Tracked

**Session Start**:
```python
parent_session = os.getenv("HTMLGRAPH_PARENT_SESSION")
session = manager.start_session(
    session_id=session_id,
    agent=agent,
    is_subagent=True,           # Marked as subagent
    parent_session_id=parent_session  # Link to parent
)
os.environ["HTMLGRAPH_PARENT_SESSION"] = session.id
```

**Database Linking**:
```python
sessions(
    session_id: str,
    parent_session_id: str,     # FK to parent session
    parent_event_id: str,       # FK to delegation event
    is_subagent: bool,          # True if spawned
)
```

**Event Linking**:
```python
EventRecord(
    parent_session_id=parent_session_id,  # Implicit link
)
```

**Result**: Complete hierarchy visible:
- Parent session → spawns → Child session
- Child session → recorded in events with parent_session_id
- All child events linked back to parent

---

## Query Capability via SDK

### Available Queries

**1. Get All Delegations for a Session**:
```python
from htmlgraph import SDK

sdk = SDK(agent="analyzer")

# From event log
events = sdk.session_manager.event_log.query_events(
    session_id="sess-abc123",
    tool="Task"  # or "Skill" for skill invocations
)

# From database (if enabled)
delegations = sdk.db.get_delegations(session_id="sess-abc123")
```

**2. Get Delegations by Agent Type**:
```python
delegations = sdk.db.get_delegations(to_agent="gemini-spawner")
```

**3. Get Delegations in a Session**:
```python
delegations = sdk.db.get_delegations(
    session_id="sess-xyz",
    from_agent="orchestrator",
    to_agent="codex-spawner"
)
```

**4. Via TaskDelegationCollection**:
```python
# High-level API for tracking delegations
delegations = sdk.task_delegations.where(agent_type="gemini-spawner")
stats = sdk.task_delegations.get_stats()
# Returns: total_delegations, by_agent_type, total_tokens, total_cost
```

**5. Cost Analysis**:
```python
cost = sum(float(d.cost_usd or 0) for d in sdk.task_delegations.all())
tokens = sum(d.tokens_used for d in sdk.task_delegations.all())
```

---

## Evidence & Implementation Details

### Files Involved

**Core Recording**:
- `src/python/htmlgraph/event_log.py` - EventRecord dataclass with delegation fields
- `src/python/htmlgraph/session_manager.py` - Session creation with parent links
- `src/python/htmlgraph/hooks/event_tracker.py` - Main tracking logic
- `src/python/htmlgraph/db/schema.py` - Database schema for delegations

**HeadlessSpawner Integration**:
- `src/python/htmlgraph/orchestration/headless_spawner.py` - spawn_gemini(), spawn_codex()
- Reads parent session from env var
- Tracks events via SDK
- Records JSONL and SQLite entries

**Collections**:
- `src/python/htmlgraph/collections/task_delegation.py` - TaskDelegationCollection API
- `create_delegation()` - Record a delegation
- `update_delegation()` - Update with results
- `get_stats()` - Aggregated stats

**Tests**:
- `tests/python/test_delegation_fk_fix.py` - Delegation recording with FK constraints
- `tests/python/test_parent_child_event_linking.py` - Parent-child relationships
- `tests/python/test_headless_spawner_parent_session.py` - Spawner integration
- `tests/integration/test_post_compact_delegation.py` - Persistence across sessions

### Example Delegation Record

From test:
```python
# Record delegation
handoff_id = db.record_delegation_event(
    from_agent="orchestrator",
    to_agent="gemini-spawner",
    task_description="Analyze codebase for patterns",
    session_id="sess-123",
    feature_id="feat-auth",
    context={
        "model": "gemini-2.0-flash",
        "budget_mode": "free",
        "expected_tokens": 50000
    }
)

# Event record created automatically in JSONL:
{
    "event_id": "evt-abc123",
    "timestamp": "2025-01-07T12:34:56Z",
    "session_id": "sess-123",
    "agent": "orchestrator",
    "tool": "Task",
    "summary": "Task: spawn_gemini(...)",
    "success": true,
    "feature_id": "feat-auth",
    "delegated_to_ai": "gemini",
    "task_id": "task-xyz",
    "task_status": "completed",
    "model_selected": "gemini-2.0-flash",
    "tokens_actual": 47500,
    "cost_usd": 0.0,
    "task_findings": "Found 3 auth patterns..."
}

# Database record in agent_collaboration:
{
    "handoff_id": "hand-abc123",
    "from_agent": "orchestrator",
    "to_agent": "gemini-spawner",
    "timestamp": "2025-01-07T12:34:56Z",
    "feature_id": "feat-auth",
    "session_id": "sess-123",
    "handoff_type": "delegation",
    "status": "completed",
    "reason": "Analyze codebase for patterns",
    "context": {...}
}
```

---

## Key Insights

1. **Automatic Recording**: No manual setup required - all delegations recorded automatically via hooks

2. **Multi-Model Support**: Tracks which AI system was used (Gemini, Codex, Copilot, Claude)

3. **Cost Tracking**: Captures tokens_actual and cost_usd for billing analysis

4. **Hierarchical**: Parent-child relationships enable orchestrator tracing

5. **Queryable**: Three ways to query (JSONL, SQLite, collections API)

6. **Rich Context**: Captures complexity level, budget mode, duration, findings

7. **Git-friendly**: JSONL append-only design prevents merge conflicts

8. **Persistent**: Survives session compaction via SQLite index

---

## Summary Table

| Aspect | Implementation |
|--------|---|
| **Is it recorded?** | Yes, automatically |
| **Where?** | JSONL logs + SQLite + HTML sessions |
| **What's captured?** | AI type, task, status, tokens, cost, duration, findings, parent session |
| **Parent-child tracking?** | Yes, via parent_session_id |
| **Query capability?** | Yes, via SDK, SQL, or event log API |
| **Cost tracking?** | Yes, tokens and USD captured |
| **Real examples?** | test_delegation_fk_fix.py shows 8 test cases |
            </div>
        </section>
    </article>
</body>
</html>
