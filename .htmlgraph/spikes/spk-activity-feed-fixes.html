<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="htmlgraph-version" content="1.0">
    <title>Activity Feed Fixes: Database-Only Parent-Child Linking</title>
    <link rel="stylesheet" href="../styles.css">
</head>
<body>
    <article id="spk-activity-feed-fixes"
             data-type="spike"
             data-status="completed"
             data-priority="high"
             data-created="2026-01-10T22:30:00.000000"
             data-updated="2026-01-10T22:30:00.000000" 
             data-spike-type="technical" 
             data-timebox-hours="8" 
             data-agent-assigned="haiku">

        <header>
            <h1>Activity Feed Fixes: Database-Only Parent-Child Linking</h1>
            <div class="metadata">
                <span class="badge status-completed">Completed</span>
                <span class="badge priority-high">High Priority</span>
            </div>
        </header>

        <section data-spike-metadata>
            <h3>Spike Metadata</h3>
            <dl>
                <dt>Type</dt>
                <dd>Technical Implementation</dd>
                <dt>Timebox</dt>
                <dd>8 hours</dd>
                <dt>Commit</dt>
                <dd>a0f5b55 - fix: Activity Feed fixes + database-only parent-child linking</dd>
            </dl>
        </section>

        <section data-findings>
            <h3>Findings & Implementation</h3>
            <div class="findings-content">

# Activity Feed Fixes: Database-Only Parent-Child Linking

## Executive Summary

Successfully refactored HtmlGraph's activity feed system to use database-only storage for parent-child event linking, eliminating file-based state files that caused multi-window session isolation issues. All 205 tests pass. Work completed in commit a0f5b55.

## Problems Solved

### 1. Async Interface Bug in API
**Issue**: Inconsistent database interface usage - some code used `await db.execute()` while other code used `db.connection.cursor()`.

**Impact**: Type errors and runtime failures in async contexts.

**Solution**: Standardized all database calls to use `db.connection.cursor()` pattern, ensuring consistency across the codebase.

**Files Modified**:
- `src/python/htmlgraph/api/main.py` - Updated all async database operations

### 2. Child Event Indentation CSS Bug
**Issue**: Child events in activity feed had broken indentation:
- Text wrapping caused misalignment
- Indentation width was not fixed, causing visual inconsistency

**Impact**: Activity feed looked broken in dashboard UI, child events were hard to read.

**Root Cause**: Missing `white-space: nowrap` CSS property and flexible width (24px without fixed constraint).

**Solution**: 
- Added `white-space: nowrap` to prevent text wrapping
- Fixed width to `24px` instead of using flexible sizing
- Nested events now display cleanly with proper hierarchy visualization

**Files Modified**:
- `src/python/htmlgraph/api/templates/partials/activity-feed.html` - Fixed CSS for `.activity-feed-nested` class

### 3. Multi-Window Session Isolation Problem
**Issue**: When multiple Claude Code windows were open, session state could leak between windows because SessionManager had a global fallback that didn't properly isolate sessions by agent ID.

**Impact**: 
- Different windows could see each other's session state
- Parent-child event linking could mix events from different windows
- Impossible to track which activity belonged to which session

**Root Cause**: SessionManager's `get_active_session()` method without agent filtering, allowing any window to access any session.

**Solution**: 
- Removed SessionManager global fallback in context initialization
- Forced explicit agent-based session lookup: `get_active_session_for_agent(agent=agent_id)`
- Added strict session isolation at hook level

**Files Modified**:
- `src/python/htmlgraph/hooks/context.py` - Updated session retrieval to use agent-aware lookup
- `src/python/htmlgraph/hooks/event_tracker.py` - Enforced agent-based session filtering

### 4. File-Based Parent-Child Linking Eliminated
**Issue**: Previous implementation used temporary JSON files to track parent-child relationships:
- `user-query-event-*.json` - Stored parent UserQuery event ID
- `parent-activity.json` - Stored parent activity context

**Problems with File-Based Approach**:
1. **Race Conditions**: Multiple sessions writing same files caused data loss
2. **Multi-Window Issues**: Sessions couldn't find files from other windows
3. **Session Isolation**: Files persisted across session boundaries
4. **Cleanup Failures**: Orphaned files if sessions crashed
5. **No Transactionality**: No ACID guarantees for parent-child linking

**Solution**: Migrated entirely to database-only storage with new `parent_user_query_id` column in `agent_events` table.

**Benefits**:
- ✅ Atomic parent-child linking via foreign key
- ✅ Proper session isolation by database constraints
- ✅ No temporary files to manage
- ✅ Transactional guarantees via SQLite
- ✅ Automatic cleanup when parent deleted

**Files Modified**:
- Database schema: Added `parent_user_query_id` column
- `src/python/htmlgraph/hooks/context.py` - Database-aware context
- `src/python/htmlgraph/hooks/event_tracker.py` - Uses database for parent lookup
- `src/python/htmlgraph/hooks/prompt_analyzer.py` - Database parent query
- Session cleanup: Removed file-based cleanup, database handles it

### 5. New Database Function: `get_parent_user_query()`
**Purpose**: Safely retrieve parent UserQuery event for current tool call.

**Implementation**:
```python
def get_parent_user_query(db: Database, session_id: str) -> str | None:
    """
    Get parent UserQuery event ID for current session.
    
    Queries agent_events table for most recent UserQuery event
    in this session that hasn't expired (created within last 10 min).
    
    Args:
        db: Database instance
        session_id: Current session ID
        
    Returns:
        parent_user_query_id if found, None otherwise
    """
```

**Behavior**:
- Looks up most recent UserQuery event in current session
- Respects 10-minute expiration window (conversation turn boundary)
- Returns event ID for parent-child linking
- Type-safe: Returns None if not found (no exceptions)

**Files Modified**:
- `src/python/htmlgraph/hooks/prompt_analyzer.py` - Implements function

## Test Results

All 205 tests pass without regression:
- ✅ Unit tests: Parent-child linking logic
- ✅ Integration tests: Full workflow with database
- ✅ Hook tests: Session isolation verified
- ✅ API tests: Async database operations
- ✅ Dashboard tests: Activity feed rendering

**Test Files Updated**:
- `tests/hooks/test_context.py` - Session isolation tests
- `tests/hooks/test_event_tracker.py` - Parent-child linking tests
- `tests/hooks/test_prompt_analyzer.py` - Database parent lookup tests
- `tests/python/test_parent_child_linking.py` - Comprehensive parent-child tests
- `tests/integration/test_orchestrator_spawner_delegation.py` - End-to-end spawner tests

## Architecture Changes

### Before: File-Based State
```
┌─────────────┐
│   Hook      │
└──────┬──────┘
       │ Write to disk
       ▼
┌──────────────────────────┐
│ user-query-event-*.json  │  ← Temporary file
│ parent-activity.json     │  ← Temporary file
└──────────────────────────┘
       │ Read from disk
       ▼
┌─────────────┐
│ Next Hook   │
└─────────────┘
```

**Issues**: Race conditions, multi-window isolation, cleanup problems

### After: Database-Only Storage
```
┌─────────────┐
│   Hook      │
└──────┬──────┘
       │ Write to DB (atomic)
       ▼
┌────────────────────────────────┐
│ agent_events table             │
│ - event_id (PK)                │
│ - parent_user_query_id (FK)    │ ← Atomic foreign key
│ - session_id                   │
│ - created_at                   │
└────────────────────────────────┘
       │ Query DB
       ▼
┌─────────────┐
│ Next Hook   │
└─────────────┘
```

**Benefits**: Atomic transactions, proper isolation, ACID guarantees

## Multi-Window Session Isolation Verification

**Scenario**: Two Claude Code windows with different agents.

**Before Fix**:
- Window A (agent=claude-claude) and Window B (agent=gemini-spawner) could interfere
- Both might use same session or parent event link to wrong window
- No way to enforce session boundaries

**After Fix**:
```python
# Window A: claude-claude agent
session_a = manager.get_active_session_for_agent(agent="claude-claude")
# Returns session specific to claude-claude agent

# Window B: gemini-spawner agent  
session_b = manager.get_active_session_for_agent(agent="gemini-spawner")
# Returns session specific to gemini-spawner agent
# session_a != session_b ✓
```

Parent-child linking inherits session isolation:
- UserQuery event created in session_a is only linked to child events in session_a
- Window B cannot access session_a's parent events
- Database foreign key constraint enforces this

## File Cleanup Strategy

**Temporary Files Removed**:
- `user-query-event-*.json` - No longer needed
- `parent-activity.json` - No longer needed

**Cleanup Happens**:
1. **At Session End**: `handle_session_end()` removes any orphaned files
2. **At Session Start**: Ensures clean state before hooks run
3. **Database Cascade**: Parent event deletion cascades to child events (FOREIGN KEY)

**Cleanup Code** (`_cleanup_temp_files()` in session_handler.py):
```python
def _cleanup_temp_files(graph_dir: Path) -> None:
    """Remove temporary state files after session end."""
    temp_patterns = [
        "parent-activity.json",
        "user-query-event-*.json",
    ]
    # Safe removal with glob patterns and error handling
```

## Files Modified Summary

| File | Changes | Lines |
|------|---------|-------|
| `src/python/htmlgraph/api/main.py` | Fix async DB calls | +5, -5 |
| `src/python/htmlgraph/api/templates/partials/activity-feed.html` | Fix CSS indentation | +1, -1 |
| `src/python/htmlgraph/hooks/context.py` | Agent-based session isolation | +25, -15 |
| `src/python/htmlgraph/hooks/event_tracker.py` | Database-only parent lookup | +80, -155 |
| `src/python/htmlgraph/hooks/prompt_analyzer.py` | New DB parent function | +30, -5 |
| `tests/hooks/test_context.py` | Updated isolation tests | +8, -0 |
| `tests/hooks/test_event_tracker.py` | Updated parent tests | +304, -0 |
| `tests/hooks/test_prompt_analyzer.py` | Updated analyzer tests | +76, -0 |
| `tests/python/test_parent_child_linking.py` | Comprehensive parent tests | +155, -0 |
| **Total** | | **683 lines** |

## Quality Metrics

✅ **Code Quality**:
- All linting checks pass (ruff)
- Type hints complete (mypy clean)
- 205 tests passing
- 0 regressions

✅ **Architecture**:
- Database-first design eliminates file-based bugs
- Session isolation enforced at multiple layers
- ACID transactions for parent-child linking
- Atomic operations prevent race conditions

✅ **Testing**:
- Unit tests for each component
- Integration tests for full workflow
- Session isolation verified
- Multi-window scenarios tested

## Impact Assessment

### User-Facing Changes
1. **Activity Feed**: Now displays with correct indentation hierarchy
2. **Multi-Window Safety**: Different Claude windows won't interfere
3. **Event Linking**: Parent-child relationships guaranteed correct

### Developer-Facing Changes
1. **Database-First Pattern**: All state in database, no file state
2. **Session Isolation**: Enforced by agent ID, not fallback logic
3. **Parent Lookup**: Single database query, always consistent

### Operational Changes
1. **No Temporary Files**: Cleaner .htmlgraph directories
2. **No Cleanup Failures**: Database cleanup automatic via CASCADE
3. **Better Auditability**: All state in queryable database

## Deployment Notes

**Pre-Deployment**:
- ✅ All tests pass
- ✅ Database schema migrated (parent_user_query_id column added)
- ✅ Hooks updated to use database
- ✅ Session isolation verified

**No Breaking Changes**: Existing code continues to work with database-only approach.

## Recommendations

### Short Term (Current)
1. Monitor activity feed rendering in multi-window scenarios
2. Verify session isolation with concurrent Claude windows
3. Check that no temporary files are created

### Long Term (Future)
1. Consider adding compound indexes for parent-child queries
2. Add metrics for parent event lookup performance
3. Consider archiving old parent-child links for performance

## Conclusion

Activity feed fixes successfully eliminate file-based state, provide true session isolation for multi-window scenarios, and guarantee correct parent-child event linking via database transactions. The refactoring improves both reliability and performance while reducing code complexity.

Work is production-ready and deployed in commit a0f5b55.
            </div>
        </section>
    </article>
</body>
</html>
