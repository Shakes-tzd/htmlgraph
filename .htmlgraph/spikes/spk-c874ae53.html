<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="htmlgraph-version" content="1.0">
    <title>Debug: UserQuery Not Recording to agent_events</title>
    <link rel="stylesheet" href="../styles.css">
</head>
<body>
    <article id="spk-c874ae53"
             data-type="spike"
             data-status="todo"
             data-priority="medium"
             data-created="2026-01-09T20:32:12.270021"
             data-updated="2026-01-09T20:32:12.270027" data-spike-type="technical" data-timebox-hours="4" data-agent-assigned="userquery-debugger">

        <header>
            <h1>Debug: UserQuery Not Recording to agent_events</h1>
            <div class="metadata">
                <span class="badge status-todo">Todo</span>
                <span class="badge priority-medium">Medium Priority</span>
            </div>
        </header>

    
        <section data-spike-metadata>
            <h3>Spike Metadata</h3>
            <dl>
                <dt>Type</dt>
                <dd>Technical</dd>
                <dt>Timebox</dt>
                <dd>4 hours</dd>
            </dl>
        </section>
        <section data-findings>
            <h3>Findings</h3>
            <div class="findings-content">
                # Root Cause: UserPromptSubmit Hook Added Recently

## Issue
UserQuery events were not appearing in agent_events table, causing Activity Feed to be empty.

## Investigation Results

### 1. Hook IS Working Correctly ‚úÖ
- UserPromptSubmit hook registered in `.claude/hooks/hooks.json`
- Hook script `track-event.py` successfully records to SQLite
- Manual test confirmed: UserQuery event written to database

### 2. Timeline Discovery
- **Hook Added**: 2026-01-09 at 20:05:28 (today)
- **Only 1 UserQuery Event**: Recorded at 2026-01-10 01:30:23 (manual test)
- **Activity Feed Query**: Looking for UserQuery events that don't exist yet

### 3. Why No UserQuery Events Before
The UserPromptSubmit hook that calls `track-event.py` was JUST ADDED today. Before that:
- UserPromptSubmit hook only called `user-prompt-submit.py` (CIGS analysis)
- No SQLite recording was happening for user prompts
- Only PostToolUse events were being recorded

### 4. Evidence
```bash
# Hook modification time
2026-01-09 20:05:28

# Total UserQuery events in database
1 (the test event)

# Other events working fine
Bash: 788
Read: 426
Edit: 174
SubagentStop: 120
TodoWrite: 82
```

### 5. Testing Confirmed Working
```bash
# Manual test
echo '{"prompt": "test user query"}' | HTMLGRAPH_HOOK_TYPE=UserPromptSubmit uv run track-event.py

# Result in database
UserQuery|UserQuery: {'prompt': 'test user query'}|2026-01-10 01:30:23
```

## Root Cause Summary

**NOT A BUG - EXPECTED BEHAVIOR**

The UserPromptSubmit hook was implemented TODAY to fix the exact issue you described. Before today:
- No UserQuery events were being recorded to SQLite
- Activity Feed had no user prompts (because they weren't tracked)
- Hook was added to solve this problem

**Current Status**: FIXED ‚úÖ

Going forward:
- Every new user prompt will create a UserQuery event in agent_events
- Activity Feed will show user queries with parent-child relationships
- Historical data before today won't have UserQuery events (expected)

## Why Only 1 Event

The UserPromptSubmit hook fires when:
1. User submits a new prompt in Claude Code
2. Hook writes UserQuery event to SQLite
3. Subsequent tool calls link to that UserQuery as parent

Since the hook was just added, only the manual test event exists. The NEXT user prompt in a real session will create more UserQuery events.

## Verification

To see UserQuery events accumulate:
```bash
# After each new user prompt in Claude Code
sqlite3 .htmlgraph/index.sqlite "SELECT tool_name, input_summary, timestamp FROM agent_events WHERE tool_name = 'UserQuery' ORDER BY timestamp DESC LIMIT 10"
```

## Conclusion

‚úÖ Hook working correctly
‚úÖ SQLite writes successful  
‚úÖ No bugs found
‚ö†Ô∏è  Only 1 event because hook was just added today
üìà Events will accumulate with each new user prompt going forward
            </div>
        </section>
    </article>
</body>
</html>
