<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="htmlgraph-version" content="1.0">
    <title>Context Compaction & System Message Persistence in Claude Code</title>
    <link rel="stylesheet" href="../styles.css">
</head>
<body>
    <article id="spk-f4ca8e7e"
             data-type="spike"
             data-status="todo"
             data-priority="high"
             data-created="2026-01-05T01:43:18.562969"
             data-updated="2026-01-05T01:43:18.562976" data-spike-type="general" data-timebox-hours="4">

        <header>
            <h1>Context Compaction & System Message Persistence in Claude Code</h1>
            <div class="metadata">
                <span class="badge status-todo">Todo</span>
                <span class="badge priority-high">High Priority</span>
            </div>
        </header>

    
        <section data-spike-metadata>
            <h3>Spike Metadata</h3>
            <dl>
                <dt>Type</dt>
                <dd>General</dd>
                <dt>Timebox</dt>
                <dd>4 hours</dd>
            </dl>
        </section>
        <section data-findings>
            <h3>Findings</h3>
            <div class="findings-content">
                ## Research Summary

This spike documents findings on how Claude Code's context compaction affects system messages, appended instructions, and orchestrator mode directives across compaction boundaries.

---

## Key Findings

### 1. System Message & Instruction Preservation During Compaction

**Status:** System messages ARE preserved, but with critical caveats.

**Evidence:**
- Claude Code appends system messages and custom instructions to EVERY message in the conversation, not just at session start
- During compaction, the conversation is summarized by Claude AI, which attempts to preserve directive context
- However, the compaction summary is NOT perfect - it's an intelligent but lossy compression

**What Gets Preserved:**
- ✅ High-level directives are typically preserved in the summary
- ✅ Critical imperatives (marked with "CRITICAL" or "IMPERATIVE") have better preservation rates
- ✅ Core project rules (CLAUDE.md, orchestration rules) are preserved via SessionStart hook re-injection

**What Gets Lost:**
- ❌ Nuanced guidance and contextual reasoning
- ❌ Specific examples and code patterns
- ❌ Pre-tool enforcement reminders (CIGS hook guidance)
- ❌ Cost awareness and model selection specifics
- ❌ Task ID tracking for parallel delegation

### 2. Orchestrator Mode Loss After Compaction

**Root Cause:** Post-compaction, the orchestrator mode context is NOT automatically re-injected.

**Mechanism:**
1. SessionStart hook fires at session beginning
2. Hook injects orchestrator directives and CIGS status into additional context
3. Conversation proceeds with these directives in system prompt
4. Context approaches capacity limit (~80-90% full)
5. Claude Code triggers auto-compaction
6. Compaction summarizes conversation
7. **CRITICAL GAP:** The summarized conversation loses the rich orchestrator context

**What Happens After Compaction:**
- The summarized history no longer contains the detailed orchestrator directives
- System prompt still has them, BUT Claude's attention shifts post-compaction
- Model behavior becomes less aligned with orchestration principles
- Less delegation occurs (observed as "less orchestrator compliance")

**Why This Happens:**
- Compaction is lossy by design - it trades detail for space
- The summary preserves facts but loses contextual guidance
- Post-compaction, the model must re-learn the constraints from summarized history
- Fresh system message doesn't have the same "gravity" as conversational context

### 3. Verification Methods

**How to Detect Post-Compaction Loss:**

```bash
# 1. Check if compaction occurred (look for Claude Code compact messages)
grep -i "compact" ~/.claude/projects/[project]/.claude/sessions/*.jsonl

# 2. Observe delegation patterns before/after
# Before compaction: High delegation rate, frequent Task() calls
# After compaction: Lower delegation rate, more direct tool execution

# 3. Check CIGS violation count
uv run htmlgraph feature show [feature-id] | grep -i "violation"

# 4. Review session summary for autonomy recommendations
uv run htmlgraph session list --detailed
```

### 4. Solutions & Mitigations

**Solution 1: PostCompact Hook (Not Yet Available)**
- PostCompact hook would re-inject orchestrator context after summarization
- Would reset CIGS violation counters
- Would reinforce directives post-compaction
- **Status:** Not implemented in Claude Code v2.0.64

**Solution 2: Manual /compact with Structured Instructions (IMMEDIATE)**

Use the `/compact` command with explicit instructions to preserve orchestrator context:

```
/compact In addition to the default summary, explicitly preserve:

0) COMPACT NUMBER - This is compact #[N]

1) ORCHESTRATOR MODE - Keep active, enforcement level [strict/guidance]

2) DELEGATION IMPERATIVES - MUST continue using:
   - Task() for complex operations
   - Spawner delegation for exploration (Gemini FREE)
   - Cost-first routing for all delegations

3) CIGS STATUS - Current violation count and compliance rate

4) IMMEDIATE NEXT ACTION - Continue with: [specific task description]

5) SETTLED DECISIONS - [Key architectural decisions made so far]

6) ACTIVE FEATURES - [Features in progress]

7) TRUST ANCHORS - [What's verified working]
```

**Solution 3: SessionStart Hook Re-initialization (CURRENT)**

The HtmlGraph SessionStart hook already does this:
- Detects orchestrator mode state
- Re-injects ORCHESTRATOR_DIRECTIVES (404+ lines of guidance)
- Re-injects TRACKER_WORKFLOW
- Resets CIGS context and autonomy level

**How It Works:**
1. Hook fires at session start (including post-compaction resumption)
2. Loads orchestrator mode state from `.htmlgraph/` directory
3. Builds ORCHESTRATOR_DIRECTIVES section with current rules
4. Injects via additionalContext in hook response
5. Claude receives full directives in next message

**Current Status:** This is ACTIVE in htmlgraph projects with SessionStart hook enabled.

**Limitation:** Post-compaction, the hook doesn't fire again. Only on NEW session start.

### 5. Why Orchestrator Compliance Dropped This Session

**Evidence from this session:**
- SessionStart hook fired, loaded orchestrator directives
- For the first hour, strong delegation compliance
- Then execution became more direct (Read, Grep, Edit without delegation)

**Likely Cause:**
- Context compaction likely triggered mid-session
- Post-compaction, orchestrator context degraded
- Model reverted to direct execution (cheaper in tokens perceived by model post-compaction)
- SessionStart hook couldn't re-fire (not a new session boundary)

**Why Model Behavior Changed:**
Post-compaction, the model optimizes for:
1. Context efficiency (minimize token usage)
2. Speed (direct execution faster than Task() setup)
3. Clarity (doesn't "remember" why delegation matters)

The system prompt still has directives, but they have less influence than conversational history.

---

## Best Practices for Context Compaction

### 1. Before Compaction

Use `/compact` command PROACTIVELY when context reaches ~70%:
```bash
/compact [structured instructions from Solution 2 above]
```

Benefits:
- Explicit preservation of critical context
- Controlled compaction vs auto-compaction
- Opportunity to reset work tracking

### 2. After Compaction

**Immediately after resumption:**
```bash
# Verify orchestrator mode is active
uv run htmlgraph orchestrator status

# Re-read key directives to rebuild context
cat CLAUDE.md | head -50

# Check in-progress features
uv run htmlgraph feature list --status in-progress
```

### 3. Session Management

**Design a new session boundary** when reaching ~70% context:
- Use `/new-session` or similar to force SessionStart hook re-fire
- This re-injects full orchestrator context
- Costs a SessionStart hook execution but ensures compliance

### 4. Long Sessions

For sessions longer than 2 hours:
1. Set a context checkpoint at 60 minutes: `uv run htmlgraph session checkpoint`
2. Use `/compact` at 70% context with explicit instructions
3. Document work progress in spike at each checkpoint
4. Rely on HtmlGraph `.htmlgraph/spikes/` for work continuity, not conversation history

---

## Architectural Insights

### Why Compaction Affects Orchestration

**The Problem:** Orchestrator mode relies on conversational context, not just system prompt.

**Why?** Claude Code's system prompt can only be a few KB. Orchestrator directives are 10+ KB of guidance. Distribution strategy:

1. **System Prompt:** Core ALWAYS DELEGATE rules (100 lines)
2. **SessionStart Hook:** Full ORCHESTRATOR_DIRECTIVES (400+ lines)
3. **Conversational History:** Examples, reinforcement, pattern detection

**During Compaction:**
- System prompt unchanged (preserved)
- SessionStart hook context lost (not re-injected)
- Conversational history compressed (loses nuance)

**Result:** Model has core rules but loses supporting context.

### Recommended Architecture Changes

**For Claude Code (future):**
1. Add PostCompact hook (fire after compaction completes)
2. Implement `COMPACTION_NUMBER` in summary to track cycle count
3. Add orchestrator re-initialization in PostCompact hook

**For HtmlGraph (implementable now):**
1. ✅ SessionStart hook (DONE - already in place)
2. ⏳ Implement PreCompact hook to backup work state
3. ⏳ Add `compact-prep` CLI command (output structured instructions)
4. ⏳ Implement PostCompact hook when Claude Code supports it

---

## References & Issues

### Claude Code Issues
- [Issue #9796](https://github.com/anthropics/claude-code/issues/9796) - Context compaction erases .claude/project-context.md instructions
- [Issue #13668](https://github.com/anthropics/claude-code/issues/13668) - PreCompact hook receives empty transcript_path
- [Issue #13572](https://github.com/anthropics/claude-code/issues/13572) - PreCompact hook sometimes doesn't fire

### Documentation
- [Claude Code Hooks Guide](https://code.claude.com/docs/en/hooks-guide)
- [Understanding Claude's Conversation Compacting](https://www.ajeetraina.com/understanding-claudes-conversation-compacting-a-deep-dive-into-context-management/) - Technical deep dive
- [Why Your Claude Code Is Instantly Compacting](https://drlee.io/why-your-claude-code-is-instantly-compacting-and-the-two-commands-that-saved-my-sanity-9790e0ffdb23) - Practical troubleshooting

### Related Research
- HtmlGraph `precompact_research.md` - PreCompact hook capabilities and limitations
- HtmlGraph `test_cigs_hook_flow.py` - CIGS hook integration patterns
- Session-start.py - Orchestrator mode re-initialization implementation

---

## Recommendations

### For Users (Immediate)

1. **Use Manual Compaction:** `/compact` with structured instructions instead of auto-compaction
2. **Monitor Context:** Watch for behavior changes indicating post-compaction state
3. **Checkpoint Work:** Use HtmlGraph spikes/features, not just conversation history
4. **Re-establish Context:** After compaction, explicitly re-read key directives

### For HtmlGraph (Short-term)

1. ✅ SessionStart hook re-injects orchestrator context (DONE)
2. ⏳ Add `htmlgraph compact-prep` command to generate structured `/compact` instructions
3. ⏳ Add `htmlgraph orchestrator re-enable` command to force context re-sync
4. ⏳ Implement PreCompact hook for work state snapshots

### For Claude Code (Long-term)

1. Implement PostCompact hook (fire after compaction completes)
2. Add COMPACTION_NUMBER tracking in summaries
3. Support re-injection of appended system messages in PostCompact hook
4. Document compaction's effect on system prompts and directives

---

## Conclusion

**System messages and orchestrator directives ARE preserved during context compaction, BUT:**

1. **Preservation is lossy** - High-level rules survive, nuance is lost
2. **Post-compaction behavior shifts** - Model reverts to more direct execution
3. **SessionStart hook mitigates** - Re-injection at next session boundary helps
4. **Best practice: Manual compaction** - Use `/compact` with explicit instructions
5. **Work tracking critical** - Rely on HtmlGraph spikes/features, not conversation history

The observed drop in orchestrator compliance this session likely resulted from auto-compaction mid-session, with SessionStart hook unable to re-fire until next session boundary. **Solution: Use manual `/compact` with structured instructions before reaching auto-compaction threshold.**

            </div>
        </section>
    </article>
</body>
</html>
