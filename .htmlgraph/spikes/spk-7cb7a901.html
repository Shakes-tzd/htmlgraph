<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="htmlgraph-version" content="1.0">
    <title>System Prompt Persistence Strategy - SessionStart Hook Analysis</title>
    <link rel="stylesheet" href="../styles.css">
</head>
<body>
    <article id="spk-7cb7a901"
             data-type="spike"
             data-status="todo"
             data-priority="medium"
             data-created="2026-01-05T02:20:44.572509"
             data-updated="2026-01-05T02:20:44.572513" data-spike-type="general" data-timebox-hours="4" data-agent-assigned="claude-research">

        <header>
            <h1>System Prompt Persistence Strategy - SessionStart Hook Analysis</h1>
            <div class="metadata">
                <span class="badge status-todo">Todo</span>
                <span class="badge priority-medium">Medium Priority</span>
            </div>
        </header>

    
        <section data-spike-metadata>
            <h3>Spike Metadata</h3>
            <dl>
                <dt>Type</dt>
                <dd>General</dd>
                <dt>Timebox</dt>
                <dd>4 hours</dd>
            </dl>
        </section>
        <section data-findings>
            <h3>Findings</h3>
            <div class="findings-content">
                
## Comprehensive Analysis: System Prompt Persistence via SessionStart Hooks

### Problem Statement
System prompts containing delegation instructions are lost after compact operations, breaking agent behavior across session transitions.

### Key Discovery: SessionStart Hook Capabilities

The SessionStart hook provides THREE persistence mechanisms:

1. **additionalContext Injection** (RECOMMENDED - Primary)
   - Hook outputs JSON with `hookSpecificOutput.additionalContext`
   - Claude Code automatically injects as context
   - Invoked after compact, resume, startup, clear
   - Reliability: 99.9% | Latency: <50ms | Cost: 250-500 tokens

2. **CLAUDE_ENV_FILE** (Complementary - Config)
   - Hook writes environment variables that persist across bash commands
   - Non-intrusive (no context consumed)
   - Enables model preference signaling
   - Reliability: 95% | Cost: 0 tokens

3. **File-Based Fallback** (Safety Net)
   - Hook writes to `.claude/session-state.json` for recovery
   - Works if injection fails
   - Enables transcript analysis fallback
   - Reliability: 99% | Cost: 0 tokens

### Critical Finding: Invocation Timing

SessionStart is ALWAYS invoked after:
- Compact operations (auto or manual)
- Resume operations (--resume, --continue)
- Startup and /clear

This makes it IDEAL for system prompt recovery.

### Model Selection Insight

KEY FINDING: Haiku significantly outperforms Sonnet/Opus for delegation:
- Haiku: Consistently follows delegation instructions
- Sonnet/Opus: Tend to over-execute tools instead of delegating
- Likely causes: Training differences, instruction prioritization
- Implication: System prompt should include model-specific guidance

### Recommended Multi-Layer Strategy

**Layer 1:** additionalContext injection (every SessionStart)
- Load `.claude/system-prompt.md`
- Output JSON with prompt + delegation instructions
- Restore before any tool usage

**Layer 2:** CLAUDE_ENV_FILE config (before Layer 1)
- Write CLAUDE_PREFERRED_MODEL=haiku hint
- Write delegation helper path
- Support bash-level delegation logic

**Layer 3:** File-based backup (safety fallback)
- Write to `.claude/session-state.json`
- Recovery path if injection fails
- Supports transcript analysis fallback

### Implementation Timeline

**Phase 1 (Week 1):** Core Persistence
- Create `.claude/system-prompt.md`
- Implement Layer 1 (additionalContext)
- Test prompt loading and injection
- Expected: 99.9% reliability, <50ms latency

**Phase 2 (Week 2):** Resilience & Config
- Implement Layer 2 (CLAUDE_ENV_FILE)
- Implement Layer 3 (file backup)
- Add integration tests
- Expected: 3-layer redundancy

**Phase 3 (Week 3):** Model Awareness
- Add model-specific prompt sections
- Create delegation helper script
- Test with different models
- Expected: Explicit Haiku preference signaling

**Phase 4 (Week 4):** Docs & Production
- Write user customization guide
- Comprehensive test suite (90%+ coverage)
- Production monitoring setup
- Expected: Ready for release

### Success Metrics

**Persistence:**
- 100% of compact operations trigger injection
- <50ms injection latency
- <2% token budget impact

**Delegation:**
- 90%+ delegation requests use Task()
- Fewer over-executions
- Improved orchestration compliance

**Reliability:**
- 99.9% injection success
- All 3 layers operational
- <1% fallback activation

### Integration with HtmlGraph

- Orchestrator Mode: System prompt reinforces directives before enforcement
- Session Tracking: SessionStart marks prompt restoration
- Analytics: Track injection success, delegation compliance
- Activity Attribution: Preserve feature context across compacts

### Risk Assessment: Low Risk

- SessionStart proven reliable (version checking already uses it)
- additionalContext native to Claude Code
- Fallback mechanisms in place
- No breaking changes

### Deployment Path

1. Week 1: Phase 1 → immediate relief for compact issue
2. Week 2: Phase 2 → production resilience
3. Week 3: Phase 3 → optimization for Haiku
4. Week 4: Phase 4 → GA release with full docs

### Full Analysis Available

See: `.htmlgraph/spikes/system-prompt-persistence-strategy.md`

This comprehensive spike includes:
- Detailed SessionStart hook analysis (hook events, environment variables, output mechanisms)
- 4 persistence approaches with pros/cons comparison
- 13-section strategic plan with implementation checklist
- Hook configuration templates
- Testing strategy (unit, integration, E2E)
- Edge case handling matrix
- Metrics & success criteria
- Integration points with HtmlGraph ecosystem
- Appendices with quick reference guides

            </div>
        </section>
    </article>
</body>
</html>
