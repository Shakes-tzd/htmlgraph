<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="htmlgraph-version" content="1.0">
    <title>Dashboard Bug Fixes - bug-00e9bef7</title>
    <link rel="stylesheet" href="../styles.css">
</head>
<body>
    <article id="spk-3776f19a"
             data-type="spike"
             data-status="todo"
             data-priority="medium"
             data-created="2026-01-09T02:59:22.246192"
             data-updated="2026-01-09T02:59:22.246197" data-spike-type="general" data-timebox-hours="4" data-agent-assigned="bugfix-dashboard">

        <header>
            <h1>Dashboard Bug Fixes - bug-00e9bef7</h1>
            <div class="metadata">
                <span class="badge status-todo">Todo</span>
                <span class="badge priority-medium">Medium Priority</span>
            </div>
        </header>

    
        <section data-spike-metadata>
            <h3>Spike Metadata</h3>
            <dl>
                <dt>Type</dt>
                <dd>General</dd>
                <dt>Timebox</dt>
                <dd>4 hours</dd>
            </dl>
        </section>
        <section data-findings>
            <h3>Findings</h3>
            <div class="findings-content">
                ## Summary

Fixed THREE dashboard data inconsistency bugs:

### Bug 1: Unknown agents in Orchestration page (FIXED)
**Root Cause**: The `subagent_type` column was not being populated when Task events were recorded. The `insert_event()` method in `schema.py` didn't accept or store the `subagent_type` parameter.

**Fix**:
1. Added `subagent_type` parameter to `HtmlGraphDB.insert_event()` method in `schema.py`
2. Updated `record_event_to_sqlite()` in `event_tracker.py` to accept and pass `subagent_type`
3. Modified the PostToolUse handler to extract `subagent_type` from Task tool input and pass it during event recording

### Bug 2: Agent name shows "cli" instead of model name (FIXED)
**Root Cause**: The agent detection fallback chain was using hardcoded "claude-code" default. Session was created with a hardcoded agent name instead of detecting from environment.

**Fix**:
1. Created new `detect_agent_from_environment()` helper function that checks multiple environment variables in priority order:
   - HTMLGRAPH_AGENT
   - HTMLGRAPH_SUBAGENT_TYPE
   - CLAUDE_MODEL
   - ANTHROPIC_MODEL
   - HTMLGRAPH_PARENT_AGENT
2. Updated session creation to use detected agent
3. Simplified and consolidated agent detection across Stop, UserPromptSubmit, and PostToolUse handlers to use the centralized detection

### Bug 3: Event count mismatch (378 vs 210) (NOT A BUG)
**Analysis**: Both the header stats endpoint (`/api/initial-stats`) and metrics view (`/views/metrics`) query the same `agent_events` table with `COUNT(*)`. The code is consistent. The discrepancy the user observed was likely due to:
- Cache staleness (30-second TTL)
- Different database files being queried
- Browser caching showing old data

**Files Modified**:
- `src/python/htmlgraph/db/schema.py` - Added subagent_type to insert_event()
- `src/python/htmlgraph/hooks/event_tracker.py` - Centralized agent detection, added subagent_type propagation

**Quality Gates Passed**:
- ruff check: All checks passed
- ruff format: 2 files unchanged
- mypy: Success, no issues found
- pytest hooks/: 91 passed, 1 skipped
            </div>
        </section>
    </article>
</body>
</html>
