<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="htmlgraph-version" content="1.0">
    <title>Error Handling: Traceback Token Analysis</title>
    <link rel="stylesheet" href="../styles.css">
</head>
<body>
    <article id="spk-b6f7987b"
             data-type="spike"
             data-status="todo"
             data-priority="medium"
             data-created="2026-01-04T23:31:10.327393"
             data-updated="2026-01-04T23:31:10.327395" data-spike-type="general" data-timebox-hours="4">

        <header>
            <h1>Error Handling: Traceback Token Analysis</h1>
            <div class="metadata">
                <span class="badge status-todo">Todo</span>
                <span class="badge priority-medium">Medium Priority</span>
            </div>
        </header>

    
        <section data-spike-metadata>
            <h3>Spike Metadata</h3>
            <dl>
                <dt>Type</dt>
                <dd>General</dd>
                <dt>Timebox</dt>
                <dd>4 hours</dd>
            </dl>
        </section>
        <section data-findings>
            <h3>Findings</h3>
            <div class="findings-content">
                
## Error Handling: Traceback Token Analysis - Complete Research

### Problem Statement
HtmlGraph CLI installs Rich.Traceback globally with `show_locals=True`, causing 3-7x token consumption for all unhandled exceptions.

### Key Metrics
- Current Rich.Traceback cost: 375-500 tokens for typical CLI error
- Minimal error message cost: 100-150 tokens
- Token multiplier: 3-4x for typical errors, up to 5-7x for deep stacks
- Monthly impact: ~196,000 tokens overhead across 100 users (5 errors/month)

### Current State Analysis
- 43 total exception handlers in CLI (6,232 lines)
- 22 generic `except Exception` handlers (52%) fall through to Rich.Traceback
- 10 FileNotFoundError handlers, 10 ValueError handlers
- Most exceptions are user input errors (wrong IDs, missing files) - no debug value

### Design Options Evaluated

**Option A: Automatic HTML Logging**
- Pros: Full debugging info in sessions, 80-90% savings
- Cons: Medium complexity, session dependency
- Recommendation: Good secondary option

**Option B: Error Classification**
- Pros: 60-75% savings, simple classification
- Cons: Medium complexity, requires exception hierarchy redesign
- Recommendation: Good long-term improvement

**Option C: Hybrid Approach (RECOMMENDED)**
- Pros: 85-95% savings, low-medium complexity, backwards compatible
- Cons: Minimal
- Implementation: Add --verbose flag, log to session, show minimal console output
- Recommendation: BEST - implement immediately

**Option D: Debug Mode**
- Pros: Simplest (10-15 lines), immediate payoff
- Cons: Users must know about --debug flag
- Recommendation: Simple but less elegant

### Recommended Implementation: Option C

**Hybrid Approach:** Log full traceback to session HTML, show minimal error to console, provide `--verbose` flag for full output.

**Benefits:**
- 85-95% token savings (user sees 1-2 line error, full traceback in session)
- Integrates naturally with HtmlGraph session tracking
- Backwards compatible (existing code unchanged)
- Advanced users can enable verbose mode with -v flag
- Self-documenting (errors tracked in sessions for analysis)

**Implementation Outline:**
1. Add `--verbose/-v` flag to main parser (increment style)
2. Conditionally install Rich.Traceback only if verbose >= 1
3. Create centralized error handler wrapper
4. In exception handlers, log to session and show minimal message
5. Add session error log retrieval commands

**Files to Modify:**
- src/python/htmlgraph/cli.py (50-80 lines added)
- src/python/htmlgraph/session_manager.py (20-30 lines added)
- src/python/htmlgraph/exceptions.py (10-15 lines added)

**Code Pattern:**
```python
# In main():
parser.add_argument('-v', '--verbose', action='count', default=0,
                    help='Show full tracebacks')
args = parser.parse_args()

if args.verbose:
    from rich.traceback import install
    install(show_locals=True)

# Error handler:
def handle_command_error(exc: Exception, args, session_id=None):
    if args.verbose >= 2:
        console.print(Panel(traceback.format_exc(), style="red"))
    else:
        console.print(f"[red]{type(exc).__name__}: {exc}[/red]")
        if session_id:
            try:
                session.add_error({
                    'type': type(exc).__name__,
                    'message': str(exc),
                    'traceback': traceback.format_exc(),
                    'timestamp': datetime.now().isoformat()
                })
            except Exception:
                pass
    sys.exit(1)
```

### Token Cost Estimates

**Before (Current):**
- User makes invalid query: 400-600 chars traceback → 100-150 tokens
- Rich.Traceback output: 1500-2000 chars → 375-500 tokens

**After (Option C):**
- Minimal console output: 50-100 chars → 12-25 tokens
- Full traceback logged to session (disk, not tokens)

**Savings per error:** 350-475 tokens (90% reduction)
**Monthly savings (100 users, 5 errors each):** ~175,000 tokens (~$0.40/month in Haiku costs)

### HtmlGraph Integration Points

**Session Error Attachment:**
```html
<section data-errors>
    <h3>Errors</h3>
    <article data-error>
        <h4>ValueError</h4>
        <dl>
            <dt>Message</dt>
            <dd>Feature not found: feat-xyz</dd>
            <dt>Timestamp</dt>
            <dd>2026-01-04T10:35:00</dd>
            <dt>Full Traceback</dt>
            <dd><pre data-traceback>...</pre></dd>
        </dl>
    </article>
</section>
```

**New CLI Commands:**
```bash
htmlgraph session show SESSION_ID --errors      # Show all errors
htmlgraph session error SESSION_ID INDEX        # Show error details
htmlgraph analytics errors --recent 10          # Error trends
```

### Next Steps

1. **Implement Option C (Hybrid)**
   - Add --verbose flag
   - Modify Rich.Traceback installation to be conditional
   - Implement error logging to session
   - Add error handler wrapper

2. **Testing**
   - Unit tests for error handler
   - Integration tests with session tracking
   - Token cost validation (compare sizes)

3. **Documentation**
   - Update DEBUGGING.md with error logging section
   - Add --verbose usage to CLI help
   - Document error log retrieval in AGENTS.md

4. **Rollout**
   - Deploy in 0.25.0
   - Include token savings metrics in release notes
   - Monitor error logs for unexpected patterns

### Research Methods Used

1. **Code Analysis**: Grep for Rich.Traceback usage, exception handlers
2. **Documentation Review**: Rich.Traceback official docs (max_frames parameter identified)
3. **Token Estimation**: Empirical analysis of typical error output sizes
4. **Session Structure Analysis**: Reviewed .htmlgraph/spikes and .htmlgraph/sessions
5. **Complexity Assessment**: Evaluated implementation effort for each option

### Conclusion

Option C (Hybrid Approach) provides the best balance of token efficiency (85-95% savings), implementation simplicity (low-medium), and user experience (transparent, with opt-in verbose mode). Immediate implementation recommended to reduce token overhead across all HtmlGraph users.

### Full Analysis Document

See `/Users/shakes/DevProjects/htmlgraph/traceback-token-analysis.md` for complete details including:
- Current Rich.Traceback usage patterns
- Detailed token cost analysis with examples
- All four design options with pros/cons
- Implementation feasibility assessment
- Integration patterns with HtmlGraph

            </div>
        </section>
    </article>
</body>
</html>
