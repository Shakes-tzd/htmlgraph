================================================================================
CLAUDE CODE TASK ID CORRELATION - INVESTIGATION FINDINGS REPORT
================================================================================

Generated: 2026-01-12
Status: Investigation Complete - Ready for Implementation Decision
Blocking Issue: CRITICAL - Task notifications show "No child events"

================================================================================
ROOT CAUSE IDENTIFIED
================================================================================

Claude Code maintains an internal "task_id" system separate from HtmlGraph's
"event_id" system. When a Task() completes, Claude Code's notification system
looks for "child events" linked to its task_id, but finds nothing because:

1. PreToolUse hook creates agent_events record with our event_id (evt-abc123)
2. Task() executes internally with Claude Code's task_id (task-xyz123)
3. PostToolUse hook receives tool_response but ❓ UNCLEAR if task_id is exposed
4. No mapping created between our event_id and Claude Code's task_id
5. Claude Code's notification system can't find our events

Result: Task notifications show "No child events" even though database has them

================================================================================
INVESTIGATION FINDINGS
================================================================================

✅ CONFIRMED - What We Know Works:
──────────────────────────────────
  • PreToolUse creates task_delegation events with our event_id
  • Parent-child linking works via parent_event_id in database
  • SubagentStop properly counts and tracks child events
  • HtmlGraph displays complete task hierarchy correctly
  • Database schema supports task_id storage in context JSON

❌ UNCONFIRMED - The Critical Gap:
──────────────────────────────────
  • Does PostToolUse hook receive task_id in tool_response?
    STATUS: ❓ UNKNOWN - MUST VERIFY
    IMPACT: Blocking - determines entire solution feasibility
    EFFORT: 30 minutes to verify

⚠️  PARTIALLY UNDERSTOOD - Hook Data Flow:
──────────────────────────────────────────
  • PreToolUse: No task_id (not generated yet)
  • PostToolUse: Likely place for task_id (needs verification)
  • SubagentStop: No task_id (receives session context only)

================================================================================
DATA AVAILABILITY ANALYSIS
================================================================================

PreToolUse Hook Input:
  Available:     "name": "Task", "input": {...}, "session_id": "..."
  Missing:       task_id (not yet generated by Claude Code)
  Action:        Create placeholder parent_event_id (DONE)

PostToolUse Hook Input:
  Available:     "tool_response": {...}
  Critical:      ❓ DOES tool_response CONTAIN task_id?
  Action:        ADD DEBUG LOGGING TO VERIFY

SubagentStop Hook Input:
  Available:     "session_id": "...", "status": "..."
  Missing:       task_id (not provided in hook)
  Action:        Use parent_event_id from environment

================================================================================
IMPLEMENTATION ROADMAP (If task_id IS Available)
================================================================================

Phase 1: Verify task_id Availability
  Status:     NOT STARTED
  Effort:     30 minutes
  Files:      DEBUG_LOGGING_PATCH.md (provided)
  Blocking:   YES - Everything else depends on this
  Action:     Apply debug patch, run Claude Code Task(), check logs

Phase 2: Implement task_id Capture (If Phase 1 succeeds)
  Status:     READY TO IMPLEMENT
  Effort:     2-3 hours
  Files:      pretooluse.py, posttooluse.py, event_tracker.py
  Storage:    Use context JSON (non-breaking)
  Action:     Extract task_id in PostToolUse, store in agent_events.context

Phase 3: Create Lookup Table (Optional)
  Status:     DESIGNED
  Effort:     1 hour
  Files:      schema.py
  Purpose:    Better query performance for API endpoints
  Action:     Create claude_task_mappings table with indexes

Phase 4: Add Tests & Documentation
  Status:     PLANNED
  Effort:     2-3 hours
  Files:      test_task_id_correlation.py, HOOK_TASK_ID_HOOKUP.md
  Action:     Unit tests, integration tests, architecture docs

================================================================================
CRITICAL DECISION POINT
================================================================================

Verification Required:
  Q: Does PostToolUse hook receive task_id in tool_response?

If YES (Most Likely):
  ✅ Solution is straightforward (2-4 hours total effort)
  ✅ Capture in PostToolUse, store mapping, done
  ✅ Claude Code can then query our events by task_id
  ✅ Task notifications will show "5 events" instead of "No child events"

If NO (Less Likely):
  ❌ Need alternative approach (6-9 hours + uncertainty)
  ❌ Workarounds: session-based, timing-based (unreliable)
  ❌ May require feature request to Anthropic
  ❌ Partial solution at best

================================================================================
NEXT STEPS (In Order)
================================================================================

1. IMMEDIATE (Required - 30 minutes):
   → Apply DEBUG_LOGGING_PATCH.md to posttooluse.py
   → Deploy with ./scripts/deploy-all.sh or --dev mode
   → Run Task() in Claude Code
   → Check logs for DEBUG output showing task_id presence/absence
   → Document findings in INVESTIGATION_SUMMARY.md

2. IF VERIFICATION SUCCEEDS (2-4 hours):
   → Implement TASK_ID_HOOKUP_PLAN.md Phases 2-4
   → Modify pretooluse.py, posttooluse.py, event_tracker.py
   → Add tests for task_id capture
   → Update documentation

3. IF VERIFICATION FAILS:
   → Contact Anthropic for feature request
   → Document known limitation in CLAUDE.md
   → Explore workaround approaches
   → Plan follow-up investigation

================================================================================
DELIVERABLES PROVIDED
================================================================================

✅ INVESTIGATION_SUMMARY.md
   Complete technical analysis of the problem, data flow, and proposed solution
   Includes: Risk assessment, file locations, success criteria

✅ TASK_ID_HOOKUP_PLAN.md
   Detailed implementation plan with code examples
   Phases: Verification, Capture, Lookup Table, Tests, Docs
   Includes: Checklist, files to modify, implementation details

✅ DEBUG_LOGGING_PATCH.md
   Ready-to-use debug code for verification
   Shows expected output formats, interpretation guide
   Includes: Quick reference, commands, removal instructions

✅ TASK_ID_INVESTIGATION.md
   Initial investigation notes and architecture overview
   Effort estimates, questions for clarification

✅ This Report
   Executive summary and critical decision points

================================================================================
EFFORT ESTIMATION
================================================================================

If task_id IS available:
  Phase 1 (Verification):     30 minutes
  Phase 2 (Implementation):   2-3 hours
  Phase 3 (Lookup Table):     1 hour (optional)
  Phase 4 (Tests/Docs):       2-3 hours
  ────────────────────────
  Total:                       ~6-8 hours (including verification)

If task_id is NOT available:
  Phase 1 (Verification):     30 minutes
  Phase 2 (Workaround):       6-9 hours + uncertainty
  ────────────────────────
  Total:                       ~7-10 hours (partial solution)

================================================================================
KEY DECISION: SCHEDULE VERIFICATION NOW
================================================================================

Recommendation: Apply debug patch immediately and verify task_id availability.

This single 30-minute action will:
  ✅ Unblock the solution design
  ✅ Provide concrete data to make implementation decision
  ✅ Enable accurate effort estimation
  ✅ Prevent wasted time on infeasible approaches
  ✅ Enable parallel planning of alternative solutions if needed

Suggested Timing: Next development session (15 minutes setup + 15 minutes testing)

================================================================================
RISK ASSESSMENT
================================================================================

Technical Risk:        LOW
  • Solution is well-defined
  • Uses non-breaking storage (context JSON)
  • Graceful degradation if task_id missing
  • No impact on existing functionality

Implementation Risk:   LOW
  • All required files identified
  • Code patterns well-established
  • Tests can be written incrementally
  • Easy rollback if issues arise

Business Risk:        MEDIUM
  • Depends on Claude Code API design (task_id exposure)
  • May require Anthropic feature request
  • Timeline uncertain if task_id not available
  • User impact high (but specific to Task notifications)

Mitigation Strategy:
  ✅ Verify before committing resources
  ✅ Start with non-breaking changes (context JSON)
  ✅ Have fallback approaches documented
  ✅ Communicate with Anthropic early if needed

================================================================================
CONTACT FOR QUESTIONS
================================================================================

Investigation conducted by: Claude Haiku (AI Assistant)
Documentation: See markdown files in project root

For implementation questions: Refer to code comments and TASK_ID_HOOKUP_PLAN.md
For architectural questions: Refer to INVESTIGATION_SUMMARY.md
For debug procedure: Refer to DEBUG_LOGGING_PATCH.md

================================================================================
END OF REPORT
================================================================================
