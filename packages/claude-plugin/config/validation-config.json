{
  "$schema": "https://json-schema.org/draft-07/schema#",
  "version": "1.0.0",
  "description": "Pre-Work Validation Hook Configuration - Enforces HtmlGraph workflow before code changes",

  "decision_framework": {
    "description": "Thresholds for determining when a work item is mandatory",
    "mandatory_if_any": [
      {
        "criterion": "file_count",
        "threshold": 3,
        "description": "Changes affecting 3+ files require a work item"
      },
      {
        "criterion": "estimated_time_minutes",
        "threshold": 30,
        "description": "Work estimated >30 minutes requires a work item"
      },
      {
        "criterion": "new_tests_needed",
        "value": true,
        "description": "Changes requiring new automated tests need a work item"
      },
      {
        "criterion": "multi_component_impact",
        "value": true,
        "description": "Changes affecting multiple components need a work item"
      },
      {
        "criterion": "hard_to_revert",
        "value": true,
        "description": "Changes that are hard to revert (schema, API) need a work item"
      },
      {
        "criterion": "needs_documentation",
        "value": true,
        "description": "Changes needing user/API documentation need a work item"
      }
    ],
    "exempt_if_all": [
      {
        "criterion": "single_file",
        "value": true,
        "description": "Single file change"
      },
      {
        "criterion": "estimated_time_minutes",
        "threshold": 30,
        "operator": "less_than",
        "description": "Quick change (<30 minutes)"
      },
      {
        "criterion": "trivial_change",
        "value": true,
        "description": "Obvious, trivial change"
      },
      {
        "criterion": "easy_to_revert",
        "value": true,
        "description": "Easy to revert"
      },
      {
        "criterion": "no_tests_needed",
        "value": true,
        "description": "No new tests required"
      }
    ]
  },

  "auto_spike_detection": {
    "description": "Rules for detecting and allowing auto-spike creation",
    "enabled": true,
    "allow_without_work_item": true,
    "spike_patterns": [
      {
        "type": "transition",
        "description": "Session transitions between features",
        "detection": {
          "method": "session_manager.create_transition_spike",
          "context_change": "feature_id changed"
        },
        "bypass": true
      },
      {
        "type": "session-init",
        "description": "Initial spike when session starts without active feature",
        "detection": {
          "method": "session_manager.create_session_init_spike",
          "context": "no active feature at session start"
        },
        "bypass": true
      }
    ],
    "validation": {
      "check_spike_fields": true,
      "required_fields": ["spike_subtype", "auto_generated", "session_id"]
    }
  },

  "tool_bypass_rules": {
    "description": "Tools that are always allowed without work items",
    "always_allow": [
      {
        "tool": "Read",
        "reason": "Exploration and understanding - no changes"
      },
      {
        "tool": "Glob",
        "reason": "File search - no changes"
      },
      {
        "tool": "Grep",
        "reason": "Content search - no changes"
      },
      {
        "tool": "LSP",
        "reason": "Code navigation - no changes"
      },
      {
        "tool": "Bash",
        "patterns": [
          "^git status",
          "^git diff",
          "^git log",
          "^ls",
          "^pwd",
          "^cat",
          "^head",
          "^tail",
          "^find",
          "^grep",
          "^uv run htmlgraph status",
          "^uv run htmlgraph feature list",
          "^uv run htmlgraph session",
          "^uv run pytest",
          "^uv run python -m pytest"
        ],
        "reason": "Read-only operations or HtmlGraph commands"
      }
    ],
    "conditional_allow": [
      {
        "tool": "Write",
        "condition": "creating_work_item",
        "reason": "Allow creating work item HTML files"
      },
      {
        "tool": "Edit",
        "condition": "updating_work_item",
        "reason": "Allow updating work item progress/status"
      },
      {
        "tool": "Bash",
        "patterns": [
          "^uv run htmlgraph feature start",
          "^uv run htmlgraph feature complete",
          "^uv run htmlgraph bug start",
          "^uv run htmlgraph spike start"
        ],
        "reason": "Work item lifecycle commands"
      }
    ],
    "require_work_item": [
      {
        "tool": "Write",
        "condition": "NOT creating_work_item",
        "description": "Writing non-work-item files requires active work item"
      },
      {
        "tool": "Edit",
        "condition": "NOT updating_work_item",
        "description": "Editing non-work-item files requires active work item"
      },
      {
        "tool": "Bash",
        "patterns": [
          "^git add",
          "^git commit",
          "^uv build",
          "^uv publish",
          "^npm",
          "^pip",
          "^python(?! -m pytest)"
        ],
        "description": "Code changes and deployments require active work item"
      }
    ]
  },

  "permission_responses": {
    "description": "Standard JSON responses for permission decisions",
    "formats": {
      "deny": {
        "decision": "deny",
        "reason": "Explanation of why the action was blocked",
        "suggestion": "Recommended action (e.g., create work item first)"
      },
      "allow": {
        "decision": "allow",
        "reason": "Explanation of why the action was permitted"
      },
      "ask": {
        "decision": "ask",
        "question": "Question to ask the user",
        "context": "Additional context for the decision"
      }
    },
    "templates": {
      "no_active_work_item": {
        "decision": "deny",
        "reason": "No active work item found. Code changes require an active feature, bug, spike, or chore.",
        "suggestion": "Create a work item first:\n  - Feature (>30 min, 3+ files): uv run htmlgraph feature create\n  - Bug (defect fix): uv run htmlgraph bug create\n  - Spike (investigation): uv run htmlgraph spike create\n  - Chore (maintenance): uv run htmlgraph chore create"
      },
      "auto_spike_allowed": {
        "decision": "allow",
        "reason": "Auto-spike creation is exempt from work item requirement"
      },
      "read_only_allowed": {
        "decision": "allow",
        "reason": "Read-only operation - no work item required"
      },
      "work_item_active": {
        "decision": "allow",
        "reason": "Active work item: {work_item_id} - {work_item_title}"
      }
    }
  },

  "validation_workflow": {
    "description": "Steps for validating tool calls before execution",
    "steps": [
      {
        "step": 1,
        "action": "check_tool_bypass",
        "description": "Check if tool is always allowed (Read, Glob, Grep, etc.)"
      },
      {
        "step": 2,
        "action": "check_auto_spike",
        "description": "Detect if this is auto-spike creation (bypass work item requirement)"
      },
      {
        "step": 3,
        "action": "get_active_work_item",
        "description": "Query for active work item (in-progress status)"
      },
      {
        "step": 4,
        "action": "apply_decision_framework",
        "description": "Evaluate if work item is required based on decision framework"
      },
      {
        "step": 5,
        "action": "return_permission",
        "description": "Return JSON decision (deny/allow/ask)"
      }
    ]
  },

  "logging": {
    "enabled": true,
    "log_file": ".htmlgraph/validation-audit.log",
    "log_denials": true,
    "log_bypasses": true,
    "log_permissions": false
  }
}
