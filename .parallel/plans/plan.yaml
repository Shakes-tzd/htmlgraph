metadata:
  name: Pre-Work Validation Hook with Auto-Spike Integration
  created: 20251225-050700
  status: ready
overview: 'Implement PreToolUse hook that enforces HtmlGraph workflow by requiring

  active work items for code changes. Integrates with auto-spike system

  and applies decision framework to determine when work items are mandatory.

  '
research:
  approach: PreToolUse hook with JSON permission decisions
  libraries:
  - name: Python stdlib
    reason: No external dependencies needed
  patterns:
  - file: track-event.py:23-71
    description: Project dir resolution and pythonpath bootstrapping
  - file: track-event.py:88-122
    description: Configuration loading pattern
  - file: session_manager.py:1176-1190
    description: Active feature detection via status filtering
  specifications:
  - requirement: Must not block auto-spike creation
    status: must_follow
  - requirement: Apply decision framework for mandatory work items
    status: must_follow
  - requirement: Use JSON permission decisions
    status: must_follow
  dependencies:
    existing:
    - htmlgraph (SessionManager, SDK)
    - Python 3.10+ stdlib
    new: []
features:
- bug-60baa800
tasks:
- id: task-0
  name: Create validation configuration schema
  file: tasks/task-0.md
  priority: blocker
  dependencies: []
- id: task-1
  name: Implement get_active_work_item() method
  file: tasks/task-1.md
  priority: blocker
  dependencies: []
- id: task-2
  name: Create PreToolUse validation hook script
  file: tasks/task-2.md
  priority: high
  dependencies:
  - task-0
  - task-1
- id: task-3
  name: Integrate with auto-spike detection
  file: tasks/task-3.md
  priority: high
  dependencies:
  - task-2
- id: task-4
  name: Update htmlgraph-tracker skill documentation
  file: tasks/task-4.md
  priority: medium
  dependencies:
  - task-2
  - task-3
- id: task-5
  name: Add validation to session-start-info
  file: tasks/task-5.md
  priority: medium
  dependencies:
  - task-1
- id: task-6
  name: Create integration tests
  file: tasks/task-6.md
  priority: high
  dependencies:
  - task-2
  - task-3
shared_resources:
  files:
  - path: src/python/htmlgraph/session_manager.py
    reason: Task 1 adds method, other tasks call it
    mitigation: Task 1 creates method first, others use it
  - path: packages/claude-plugin/skills/htmlgraph-tracker/SKILL.md
    reason: Task 4 updates documentation
    mitigation: Single task owns this file
testing:
  unit:
  - Each task writes unit tests for new methods
  - Test auto-spike detection logic
  - Test decision framework thresholds
  integration:
  - Test full validation flow with real sessions
  - Test auto-spike creation bypass
  - Test multi-file change blocking
  isolation:
  - Mock SessionManager for hook tests
  - Use test fixtures for config files
success_criteria:
- Hook blocks Write/Edit/Delete when no active work item and 3+ files
- Hook allows auto-spike creation (session-init, transition)
- Hook warns but allows single-file changes without work item
- get_active_work_item() returns correct Node or None
- All tests passing
- Documentation updated with workflow guidance
notes: 'The key challenge is detecting auto-spike file writes to allow them

  while blocking other code changes. We detect via data-auto-generated

  attribute in file content and spike-subtype matching.


  Decision framework thresholds (3+ files, >30min) are conservative

  to prioritize attribution over efficiency.

  '
changelog:
- timestamp: 20251225-050700
  event: Plan created with parallel research synthesis
